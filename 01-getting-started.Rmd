---
title: "Vignette 1: Getting started"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

---

# 1.1 What is `QDECR`?

`QDECR` is a tool that can be used to perform surface-based vertex-wise analyses in `R`. 

---

# 1.2 Requirements

In order to run `QDECR` you need to have several things ready:

* A Unix system.
* [Freesurfer](https://surfer.nmr.mgh.harvard.edu/) installed.
* Your images processed through Freesurfer with the `-qcache` flag.
* [`R`](https://www.r-project.org) installed.
* A lot of other `R` packages that will be installed automatically.

We also highly suggest:

* [`Magick++`](https://www.imagemagick.org/Magick++/STL.html); this is required for a specific plotting function (`qdecr_snap`) that you may or may not need.

## 1.2.1 Unix

QDECR runs best with Unix. 

QDECR does not work on Windows. We rely on two functions from the Freesurfer suite that require Unix/Mac, and we use one function for parallel computing that does not work in Windows. Getting QDECR to work on Windows is not a strong priority for us. 

In theory, QDECR should also work on Mac, but we have not tested it yet.

## 1.2.2 Installing Freesurfer

To install Freesurfer, [follow this tutorial](https://stackoverflow.com/questions/32530340/freesurfer-installed-on-ubuntu), but change the `wget` command to the most up-to-date version of Freesurfer (*the tutorial downloads Freesurfer 5.3.0 which is NOT the newest version*).

An error may pop up down the line. Try opening `freeview` on the command line:
```{bash eval = FALSE, tidy = FALSE}
slamballais@scs:~$ freeview
freeview.bin:  error while loading shared libraries: libpng12.so.0: cannot open shared object file: No such file or directory.
```

For Ubuntu 16.10 and higher this is a problem, as `libpng12.so.0` does not support those. There is an easy workaround:
```{bash eval = FALSE, tidy = FALSE}
wget -q -O /tmp/libpng12.deb http://mirrors.kernel.org/ubuntu/pool/main/libp/libpng/libpng12-0_1.2.54-1ubuntu1_amd64.deb \
  && sudo dpkg -i /tmp/libpng12.deb \
  && rm /tmp/libpng12.deb
```

## 1.2.3 Running -qcache

Make sure that your subjects are run through Freesurfer with the `-qcache` flag, like this:
```{bash eval = FALSE, tidy = FALSE}
recon-all -s <subject-id> -qcache
```

Full instructions can be found on the [Freesurfer QDEC page](http://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/QdecGroupAnalysis_freeview), under the header "pre-smoothed fsaverage surfaces".

## 1.2.4 Installing R

To install R on Ubuntu 18.04, [follow this tutorial](https://www.digitalocean.com/community/tutorials/how-to-install-r-on-ubuntu-18-04) and [run step 1 of this tutorial](https://www.digitalocean.com/community/tutorials/how-to-install-r-packages-using-devtools-on-ubuntu-18-04).

QDECR relies on a lot of other R packages. These will be automatically installed when you install QDECR in R (see step 1.3).

## 1.2.5 Suggestion: Install Magick++ and the R package `magick`

`Magick` is a tool for image manipulation and is easy to install as described [here](https://cran.r-project.org/web/packages/magick/vignettes/intro.html#build_from_source).

For Debian/Ubuntu:
```{bash eval = FALSE, tidy = FALSE}
sudo apt-get install libmagick++-dev
```

Consequently, in R:
```{R eval = FALSE, tidy = FALSE}
install.packages("magick")
```

---

# 1.3 Installing QDECR

First, we need to install the devtools package if it is not there yet:
```{r eval = FALSE, tidy = FALSE}
if (!requireNamespace("devtools"))
  install.packages('devtools')
```

Next, we have to grab the code from Github using the `install_github()` function:
```{r eval = FALSE, tidy = FALSE}
devtools::install_github("slamballais/QDECR")
```

This should also download all dependent packages! This can take a while.

Finally, we can choose to attach the package to make it easier to use:
```{r eval = FALSE, tidy = FALSE}
library(QDECR)
```

---

# 1.4 Other preparations

## 1.4.1 Setting global variables

QDECR assumes that you have set several global variables, namely `SUBJECTS_DIR` and `FREESURFER_HOME`. This is typically done when you configure Freesurfer, as described [here](https://surfer.nmr.mgh.harvard.edu/fswiki/SetupConfiguration_Linux).

You can check whether these variables are set by running the following `R` code:
```{r eval = FALSE, tidy = FALSE}
Sys.getenv("FREESURFER_HOME")
Sys.getenv("SUBJECTS_DIR")
```

If these return empty strings, we highly recommend that you set up these variables (as described [here](https://surfer.nmr.mgh.harvard.edu/fswiki/SetupConfiguration_Linux)). However, QDECR also has some arguments that allow you to set them directly.

## 1.4.2 Freesurfer output in SUBJECTS_DIR

The Freesurfer output directories should all be located in the same place, ideally the path that is stored by `SUBJECTS_DIR` (but this is optional). As of version 0.7.0 it is not possible to run analyses on participants spread over multiple directories.

---

[Next vignette: [2. Quick start](02-quick-start.html) or [3. Using `QDECR`](03-using-qdecr.html)]